<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Culebrita Retro — Adaptable</title>
<style>
  :root{
    --bg:#0b0f13;
    --accent:#00ff88;
    --accent2:#ffdd55;
  }
  html,body{
    height:100%;
    margin:0;
    background:linear-gradient(180deg,#020408 0%, #07111a 100%);
    font-family:"Courier New",monospace;
    color:#dfffe9;
  }
  .wrap{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100%;
    padding:12px;
    box-sizing:border-box;
    text-align:center;
  }
  canvas{
    display:block;
    background:#081016;
    image-rendering:pixelated;
    border-radius:8px;
    margin-bottom:10px;
    box-shadow:0 0 20px rgba(0,255,136,0.2);
    touch-action:none;
  }
  .score{font-size:20px;font-weight:bold;color:var(--accent2);margin-bottom:6px;}
  .status{font-size:14px;color:#aef3c8;margin-bottom:10px;}
  .btn{
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:8px;
    color:#dfffe9;
    font-weight:bold;
    text-transform:uppercase;
    padding:8px 14px;
    cursor:pointer;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="score" id="score">Score: 0</div>
  <canvas id="game" width="400" height="400" tabindex="0"></canvas>
  <div class="status" id="status">Listo</div>
  <button class="btn" id="startBtn">Iniciar</button>
  <div style="margin-top:8px;font-size:12px;opacity:0.7;">
    Usa flechas o WASD — Espacio para reiniciar
  </div>
</div>

<script>
/* === CONFIGURACIÓN GENERAL === */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d',{alpha:false});
const scoreEl = document.getElementById('score');
const statusEl = document.getElementById('status');
const startBtn = document.getElementById('startBtn');

let GRID = 20;
let CELL = 0;
let FPS = 10;
let tickInterval = null;
let snake = [];
let dir = {x:1,y:0};
let nextDir = {x:1,y:0};
let food = null;
let score = 0;
let running = false;
let pendingGrow = 0;

/* === AUDIO === */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playEat(){
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='square';o.frequency.setValueAtTime(880,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(1400,audioCtx.currentTime+0.08);
  g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.18);
  o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+0.19);
}
function playLose(){
  const n=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.type='sawtooth';o.frequency.setValueAtTime(400,n);
  o.frequency.exponentialRampToValueAtTime(60,n+0.6);
  g.gain.setValueAtTime(0.0001,n);g.gain.exponentialRampToValueAtTime(0.3,n+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001,n+0.7);
  o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(n+0.8);
}

/* === FUNCIONES BASE === */
function resizeCanvas(){
  const size = Math.min(window.innerWidth*0.8, window.innerHeight*0.7);
  canvas.width = canvas.height = Math.floor(size);
  CELL = canvas.width / GRID;
  draw();
}

function rndInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}

function placeFood(){
  const occupied = new Set(snake.map(s=>s.x+','+s.y));
  while(true){
    const x=rndInt(0,GRID-1),y=rndInt(0,GRID-1);
    if(!occupied.has(x+','+y)){food={x,y};break;}
  }
}

function resetGame(){
  const cx=Math.floor(GRID/2),cy=Math.floor(GRID/2);
  snake=[{x:cx-1,y:cy},{x:cx,y:cy},{x:cx+1,y:cy}];
  dir={x:1,y:0};nextDir={x:1,y:0};
  score=0;pendingGrow=0;running=false;
  placeFood();updateHUD();draw();
}

function updateHUD(msg){
  scoreEl.textContent="Score: "+score;
  statusEl.textContent=msg|| (running?"Jugando":"Listo");
}

/* === LÓGICA PRINCIPAL === */
function tick(){
  if(!running) return;
  if((nextDir.x!==-dir.x)||(nextDir.y!==-dir.y)) dir=nextDir;

  const head={...snake[snake.length-1]};
  head.x+=dir.x;head.y+=dir.y;

  if(head.x<0||head.x>=GRID||head.y<0||head.y>=GRID){gameOver();return;}
  for(let s of snake){if(s.x===head.x&&s.y===head.y){gameOver();return;}}

  snake.push(head);

  if(food&&head.x===food.x&&head.y===food.y){
    pendingGrow++;score++;playEat();placeFood();
  }
  if(pendingGrow>0) pendingGrow--; else snake.shift();
  updateHUD();draw();
}

function draw(){
  ctx.fillStyle="#081016";ctx.fillRect(0,0,canvas.width,canvas.height);
  if(food) drawCell(food.x,food.y,true);
  for(let i=0;i<snake.length;i++){
    const s=snake[i],head=(i===snake.length-1);
    drawCell(s.x,s.y,false,head);
  }
}

function drawCell(gx,gy,isFood=false,isHead=false){
  const x=gx*CELL,y=gy*CELL;
  if(isFood){
    ctx.fillStyle="#ffeb9a";
    ctx.fillRect(x+CELL*0.25,y+CELL*0.25,CELL*0.5,CELL*0.5);
    return;
  }
  ctx.fillStyle=isHead?"#00ff88":"#0fffc1";
  ctx.fillRect(x+1,y+1,CELL-2,CELL-2);
}

/* === EVENTOS === */
function gameOver(){
  running=false;updateHUD("Game Over");playLose();
  canvas.style.boxShadow="0 0 30px rgba(255,77,109,0.6)";
  setTimeout(()=>canvas.style.boxShadow="0 0 20px rgba(0,255,136,0.2)",600);
}

const keyMap={
  'ArrowUp':{x:0,y:-1},'ArrowDown':{x:0,y:1},
  'ArrowLeft':{x:-1,y:0},'ArrowRight':{x:1,y:0},
  'w':{x:0,y:-1},'s':{x:0,y:1},'a':{x:-1,y:0},'d':{x:1,y:0}
};
window.addEventListener('keydown',e=>{
  const k=e.key;if(k===' '){e.preventDefault();startGame();return;}
  const m=keyMap[k];if(!m)return;
  e.preventDefault();
  if(m.x===-dir.x&&m.y===-dir.y)return;
  nextDir=m;
});

function startGame(){
  if(audioCtx.state==='suspended') audioCtx.resume();
  resetGame();
  running=true;updateHUD("Jugando");
  if(tickInterval) clearInterval(tickInterval);
  tickInterval=setInterval(tick,1000/FPS);
  canvas.focus();
}

startBtn.addEventListener('click',startGame);
window.addEventListener('resize',resizeCanvas);

/* === INICIO === */
resizeCanvas();
resetGame();
canvas.focus();
</script>
</body>
</html>

